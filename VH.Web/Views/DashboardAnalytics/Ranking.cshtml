@using VH.Services.DTOs.Analytics
@{
    ViewData["Title"] = "Ranking de Consumidores";
    var ranking = ViewBag.Ranking as RankingConsumoResponseDto;
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1 fw-bold text-dark">
                <i class="bi bi-trophy text-warning me-2"></i>Ranking de Consumidores
            </h2>
            <p class="text-muted mb-0">
                Per√≠odo: @(new DateTime(ViewBag.Anio, ViewBag.Mes, 1).ToString("MMMM yyyy")) |
                @(ranking?.TotalEmpleadosAnalizados ?? 0) empleados analizados |
                Promedio: @(ranking?.PromedioGeneral.ToString("C") ?? "$0")
            </p>
        </div>
        <a asp-action="Index" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-1"></i>Volver
        </a>
    </div>

    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">A√±o</label>
                    <select name="anio" class="form-select">
                        @for (int a = DateTime.Now.Year; a >= DateTime.Now.Year - 2; a--)
                        {
                            <option value="@a" selected="@(a == ViewBag.Anio)">@a</option>
                        }
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Mes</label>
                    <select name="mes" class="form-select">
                        @for (int m = 1; m <= 12; m++)
                        {
                            <option value="@m" selected="@(m == ViewBag.Mes)">@(new DateTime(2000, m, 1).ToString("MMMM"))</option>
                        }
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Proyecto</label>
                    <select name="idProyecto" class="form-select">
                        <option value="">Todos</option>
                        @if (ViewBag.Proyectos != null)
                        {
                            @foreach (var p in ViewBag.Proyectos as List<Microsoft.AspNetCore.Mvc.Rendering.SelectListItem>)
                            {
                                <option value="@p.Value" selected="@(p.Value == ViewBag.FiltroProyecto?.ToString())">@p.Text</option>
                            }
                        }
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Puesto</label>
                    <select name="idPuesto" class="form-select">
                        <option value="">Todos</option>
                        @if (ViewBag.Puestos != null)
                        {
                            @foreach (var p in ViewBag.Puestos as List<Microsoft.AspNetCore.Mvc.Rendering.SelectListItem>)
                            {
                                <option value="@p.Value" selected="@(p.Value == ViewBag.FiltroPuesto?.ToString())">@p.Text</option>
                            }
                        }
                    </select>
                </div>
                <div class="col-12">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-funnel me-1"></i>Filtrar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-danger text-white py-3">
                    <h5 class="mb-0"><i class="bi bi-arrow-up-circle me-2"></i>Top Consumidores (Mayor Consumo)</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th width="60">#</th>
                                    <th>Empleado</th>
                                    <th>Puesto</th>
                                    <th>Proyecto</th>
                                    <th class="text-center">Entregas</th>
                                    <th class="text-end">Costo</th>
                                    <th class="text-end">Desviaci√≥n</th>
                                    <th class="text-center">Alertas</th>
                                    <th class="text-center">Riesgo</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (ranking?.TopConsumidores != null && ranking.TopConsumidores.Any())
                                {
                                    @foreach (var item in ranking.TopConsumidores)
                                    {
                                        <tr class="@(item.EsEmpate ? "table-warning" : "")">
                                            <td>
                                                @if (item.Posicion == 1)
                                                {
                                                    <span class="badge bg-warning text-dark fs-6">ü•á</span>
                                                }
                                                else if (item.Posicion == 2)
                                                {
                                                    <span class="badge bg-secondary fs-6">ü•à</span>
                                                }
                                                else if (item.Posicion == 3)
                                                {
                                                    <span class="badge bg-danger fs-6">ü•â</span>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">@item.Posicion</span>
                                                }
                                                @if (item.EsEmpate)
                                                {
                                                    <i class="bi bi-link text-warning" title="Empate"></i>
                                                }
                                            </td>
                                            <td>
                                                <a asp-action="PerfilEmpleado" asp-route-id="@item.IdEmpleado" class="text-decoration-none fw-bold">
                                                    @item.NombreCompleto
                                                </a>
                                                <br><small class="text-muted">@item.NumeroNomina</small>
                                            </td>
                                            <td><small>@item.Puesto</small></td>
                                            <td><small>@item.NombreProyecto</small></td>
                                            <td class="text-center">@item.TotalEntregas</td>
                                            <td class="text-end fw-bold">@item.CostoTotal.ToString("C")</td>
                                            <td class="text-end">
                                                @if (item.DesviacionPorcentaje > 0)
                                                {
                                                    <span class="text-danger">+@item.DesviacionPorcentaje.ToString("N1")%</span>
                                                }
                                                else
                                                {
                                                    <span class="text-success">@item.DesviacionPorcentaje.ToString("N1")%</span>
                                                }
                                            </td>
                                            <td class="text-center">
                                                @if (item.AlertasActivas > 0)
                                                {
                                                    <span class="badge bg-danger">@item.AlertasActivas</span>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">0</span>
                                                }
                                            </td>
                                            <td class="text-center">
                                                <span class="badge bg-@item.ColorIndicador">@item.NivelRiesgo</span>
                                            </td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="9" class="text-center text-muted py-4">No hay datos disponibles para el per√≠odo seleccionado</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-success text-white py-3">
                    <h5 class="mb-0"><i class="bi bi-arrow-down-circle me-2"></i>Bottom Consumidores (Menor Consumo)</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th width="60">#</th>
                                    <th>Empleado</th>
                                    <th>Puesto</th>
                                    <th>Proyecto</th>
                                    <th class="text-center">Entregas</th>
                                    <th class="text-end">Costo</th>
                                    <th class="text-end">Desviaci√≥n</th>
                                    <th class="text-center">Alertas</th>
                                    <th class="text-center">Riesgo</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (ranking?.BottomConsumidores != null && ranking.BottomConsumidores.Any())
                                {
                                    @foreach (var item in ranking.BottomConsumidores)
                                    {
                                        <tr class="@(item.EsEmpate ? "table-info" : "")">
                                            <td>
                                                <span class="text-muted">@item.Posicion</span>
                                                @if (item.EsEmpate)
                                                {
                                                    <i class="bi bi-link text-info" title="Empate"></i>
                                                }
                                            </td>
                                            <td>
                                                <a asp-action="PerfilEmpleado" asp-route-id="@item.IdEmpleado" class="text-decoration-none fw-bold">
                                                    @item.NombreCompleto
                                                </a>
                                                <br><small class="text-muted">@item.NumeroNomina</small>
                                            </td>
                                            <td><small>@item.Puesto</small></td>
                                            <td><small>@item.NombreProyecto</small></td>
                                            <td class="text-center">@item.TotalEntregas</td>
                                            <td class="text-end fw-bold">@item.CostoTotal.ToString("C")</td>
                                            <td class="text-end">
                                                <span class="text-success">@item.DesviacionPorcentaje.ToString("N1")%</span>
                                            </td>
                                            <td class="text-center">
                                                @if (item.AlertasActivas > 0)
                                                {
                                                    <span class="badge bg-danger">@item.AlertasActivas</span>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">0</span>
                                                }
                                            </td>
                                            <td class="text-center">
                                                <span class="badge bg-@item.ColorIndicador">@item.NivelRiesgo</span>
                                            </td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="9" class="text-center text-muted py-4">No hay datos disponibles para el per√≠odo seleccionado</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

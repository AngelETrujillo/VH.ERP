@using VH.Services.DTOs.Analytics
@{
    ViewData["Title"] = "Detalle de Proyecto";
    var detalle = ViewBag.Detalle as ConsumoProyectoDto;
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1 fw-bold text-dark">
                <i class="bi bi-building text-primary me-2"></i>@(detalle?.NombreProyecto ?? "Proyecto")
            </h2>
            <p class="text-muted mb-0">Detalle de consumo - @ViewBag.Mes/@ViewBag.Anio</p>
        </div>
        <div class="d-flex gap-2">
            <a asp-action="ConsumoProyectos" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-1"></i>Volver
            </a>
            <a asp-action="Index" class="btn btn-outline-primary">
                <i class="bi bi-house me-1"></i>Dashboard
            </a>
        </div>
    </div>

    @if (detalle != null)
    {
        <!-- KPIs del Proyecto -->
        <div class="row g-4 mb-4">
            <div class="col-md-3">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body text-center">
                        <i class="bi bi-cash-stack text-primary fs-1"></i>
                        <h3 class="fw-bold mt-2">@detalle.CostoTotal.ToString("C")</h3>
                        <p class="text-muted mb-0">Costo Total</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body text-center">
                        <i class="bi bi-wallet2 text-success fs-1"></i>
                        <h3 class="fw-bold mt-2">@detalle.PresupuestoAsignado.ToString("C")</h3>
                        <p class="text-muted mb-0">Presupuesto Asignado</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body text-center">
                        <i class="bi bi-people text-info fs-1"></i>
                        <h3 class="fw-bold mt-2">@detalle.TotalEmpleados</h3>
                        <p class="text-muted mb-0">Empleados</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body text-center">
                        <i class="bi bi-box-seam text-warning fs-1"></i>
                        <h3 class="fw-bold mt-2">@detalle.TotalEntregas</h3>
                        <p class="text-muted mb-0">Entregas</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Desviación y Alertas -->
        <div class="row g-4 mb-4">
            <div class="col-md-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white py-3">
                        <h5 class="mb-0"><i class="bi bi-graph-up me-2"></i>Desviación Presupuestal</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <span>Consumo vs Presupuesto</span>
                            <span class="badge bg-@detalle.ColorBarra fs-5">
                                @(detalle.DesviacionPresupuesto > 0 ? "+" : "")@detalle.DesviacionPresupuesto.ToString("N1")%
                            </span>
                        </div>
                        @{
                            var porcentajeUso = detalle.PresupuestoAsignado > 0
                            ? Math.Min((detalle.CostoTotal / detalle.PresupuestoAsignado) * 100, 150)
                            : 0;
                        }
                        <div class="progress" style="height: 25px;">
                            <div class="progress-bar bg-@detalle.ColorBarra" role="progressbar"
                                 style="width: @Math.Min(porcentajeUso, 100)%">
                                @porcentajeUso.ToString("N0")%
                            </div>
                        </div>
                        <div class="d-flex justify-content-between mt-2 small text-muted">
                            <span>$0</span>
                            <span>@detalle.PresupuestoAsignado.ToString("C")</span>
                        </div>

                        <hr />

                        <div class="row text-center">
                            <div class="col">
                                <h5 class="mb-0">@detalle.CostoPromedioPorEmpleado.ToString("C")</h5>
                                <small class="text-muted">Costo promedio por empleado</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white py-3">
                        <h5 class="mb-0"><i class="bi bi-exclamation-triangle me-2"></i>Alertas del Proyecto</h5>
                    </div>
                    <div class="card-body">
                        @if (detalle.TotalAlertas > 0)
                        {
                            <div class="row text-center">
                                <div class="col-6">
                                    <div class="p-3 bg-danger bg-opacity-10 rounded">
                                        <h2 class="fw-bold text-danger mb-0">@detalle.AlertasCriticas</h2>
                                        <small class="text-muted">Críticas</small>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="p-3 bg-warning bg-opacity-10 rounded">
                                        <h2 class="fw-bold text-warning mb-0">@detalle.TotalAlertas</h2>
                                        <small class="text-muted">Total</small>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-3">
                                <a asp-controller="AlertasConsumo" asp-action="Index" asp-route-idProyecto="@detalle.IdProyecto"
                                   class="btn btn-outline-danger w-100">
                                    <i class="bi bi-eye me-1"></i>Ver alertas del proyecto
                                </a>
                            </div>
                        }
                        else
                        {
                            <div class="text-center py-4">
                                <i class="bi bi-check-circle text-success" style="font-size: 3rem;"></i>
                                <h5 class="mt-3 text-success">Sin alertas</h5>
                                <p class="text-muted">Este proyecto no tiene alertas pendientes.</p>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Información adicional -->
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white py-3">
                <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Información del Proyecto</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tr>
                                <th class="text-muted" width="40%">Tipo de Obra:</th>
                                <td>@(string.IsNullOrEmpty(detalle.TipoObra) ? "No especificado" : detalle.TipoObra)</td>
                            </tr>
                            <tr>
                                <th class="text-muted">Estado Presupuesto:</th>
                                <td>
                                    @if (detalle.SobrePresupuesto)
                                    {
                                        <span class="badge bg-danger">Sobre presupuesto</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-success">Dentro del presupuesto</span>
                                    }
                                </td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tr>
                                <th class="text-muted" width="40%">Total Empleados:</th>
                                <td>@detalle.TotalEmpleados</td>
                            </tr>
                            <tr>
                                <th class="text-muted">Total Entregas:</th>
                                <td>@detalle.TotalEntregas</td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center py-5">
                <i class="bi bi-exclamation-circle text-warning" style="font-size: 4rem;"></i>
                <h4 class="mt-3">No se encontraron datos</h4>
                <p class="text-muted">No hay información de consumo para este proyecto en el período seleccionado.</p>
                <a asp-action="ConsumoProyectos" class="btn btn-primary">
                    <i class="bi bi-arrow-left me-1"></i>Volver a proyectos
                </a>
            </div>
        </div>
    }
</div>


